<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>US State Metrics Map</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
    }

    .title {
      margin: 20px 0;
      font-size: 24px;
      font-weight: bold;
    }

    .map-container {
      background-color: rgb(248, 209, 226);
      padding: 20px;
      position: relative;
      display: inline-block;
      border-radius: 10px;
    }

    .dropdown {
      position: absolute;
      font-size: 16px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #ffffff;
      z-index: 10;
    }

    #year {
      top: 10px;
      left: 10px;
    }

    #metric {
      top: 50px;
      left: 10px;
    }

    svg {
      display: block;
    }

    .tooltip {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      padding: 5px;
      pointer-events: none;
    }

    #controls-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    #year-slider {
      width: 100%;
    }

    #metric {
      width: 300px;
    }

    #slider-container {
      margin-bottom: 15px;
    }

    .description {
      margin: 10px 0 20px;
      font-size: 16px;
      text-align: center;
      max-width: 960px;
      line-height: 1.5;
      color: #333;
    }
  </style>
</head>

<body>
  <div class="title">US State Metrics Visualization</div>

  <div class="description">
    This map visualizes state-level metrics such as Total Personal Income, GDP, and Consumer Spending for the United
    States.
    Use the slider to select a year and the dropdown menu to choose a metric. Hover over a state to see detailed
    information
    for the selected year and metric.
  </div>

  <div class="map-container">
    <div id="controls-container" style="position: relative; margin-bottom: 20px;">
      <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 15px;">
        <div id="slider-container" style="width: 300px;">
          <label id="year-label" style="font-size: 16px; font-weight: bold;">Year: 2000</label>
          <input id="year-slider" type="range" class="slider" min="0" max="0" step="1" value="0"
            style="width: 100%; margin-top: 5px;">
        </div>
        <select id="metric" class="dropdown" style="margin-top: 20px;">
          <option value="personalIncome">Total Personal Income by State</option>
          <option value="gdp">Total GDP by State</option>
          <option value="consumerSpending">Total Consumer Spending by State</option>
        </select>
      </div>
    </div>
    <svg width="960" height="600"></svg>
    <div id="legend"></div>
  </div>

  <div class="tooltip" style="display: none;"></div>

  <script>
    const width = 960, height = 600;
    const svg = d3.select("svg");
    const tooltip = d3.select(".tooltip");

    const projection = d3.geoAlbersUsa().scale(1000).translate([width / 2, height / 2]);
    const path = d3.geoPath().projection(projection);

    const stateIdToName = {
      1: "Alabama",
      2: "Alaska",
      4: "Arizona",
      5: "Arkansas",
      6: "California",
      8: "Colorado",
      9: "Connecticut",
      10: "Delaware",
      11: "District of Columbia",
      12: "Florida",
      13: "Georgia",
      15: "Hawaii",
      16: "Idaho",
      17: "Illinois",
      18: "Indiana",
      19: "Iowa",
      20: "Kansas",
      21: "Kentucky",
      22: "Louisiana",
      23: "Maine",
      24: "Maryland",
      25: "Massachusetts",
      26: "Michigan",
      27: "Minnesota",
      28: "Mississippi",
      29: "Missouri",
      30: "Montana",
      31: "Nebraska",
      32: "Nevada",
      33: "New Hampshire",
      34: "New Jersey",
      35: "New Mexico",
      36: "New York",
      37: "North Carolina",
      38: "North Dakota",
      39: "Ohio",
      40: "Oklahoma",
      41: "Oregon",
      42: "Pennsylvania",
      44: "Rhode Island",
      45: "South Carolina",
      46: "South Dakota",
      47: "Tennessee",
      48: "Texas",
      49: "Utah",
      50: "Vermont",
      51: "Virginia",
      53: "Washington",
      54: "West Virginia",
      55: "Wisconsin",
      56: "Wyoming"
    };

    const metricLabels = {
      personalIncome: "Total Personal Income [Millions of Dollars]",
      gdp: "GDP",
      consumerSpending: "Total Consumer Spending [Millions of Dollars]"
    };

    const metricUnits = {
      personalIncome: "USD",
      gdp: "Billion USD",
      consumerSpending: "USD"
    };

    const loadData = async () => {
      const geoData = await d3.json("data/cleaned-us-state-boundaries.json");
      const personalIncome = await d3.csv("data/cleaned-personal-income.csv");
      const gdp = await d3.csv("data/cleaned-gdp.csv");
      const consumerSpending = await d3.csv("data/cleaned-consumer-spending.csv");

      const states = topojson.feature(geoData, geoData.objects.states);

      const allData = { personalIncome, gdp, consumerSpending };

      const years = Object.keys(personalIncome[0]).filter(d => !isNaN(d));

      const globalMinMax = {};
      Object.keys(allData).forEach(metric => {
        const values = allData[metric].flatMap(row =>
          years.map(year => +row[year]).filter(value => !isNaN(value))
        );
        globalMinMax[metric] = [d3.min(values), d3.max(values)];
      });

      return { states, allData, years, globalMinMax };
    };

    const updateMap = (states, data, metric, year, globalMinMax) => {
      const [globalMin, globalMax] = globalMinMax[metric];
      const allValues = data[metric].flatMap(row => {
        const value = +row[year];
        return !isNaN(value) ? value : [];
      });
      const quantiles = d3.scaleQuantile()
        .domain(allValues)
        .range(d3.schemeBlues[9]);

      d3.select("svg").selectAll("path")
        .data(states.features)
        .join("path")
        .attr("d", path)
        .attr("fill", d => {
          const stateName = stateIdToName[d.id];
          const stateData = data[metric].find(row => row.GeoName === stateName);
          const value = stateData ? +stateData[year] : null;
          return value ? quantiles(value) : "#ccc";
        })
        .attr("stroke", "#000")
        .attr("stroke-width", 0.5)
        .on("mouseover", (event, d) => {
          const stateName = stateIdToName[d.id];
          const stateData = data[metric].find(row => row.GeoName === stateName);
          const value = stateData ? +stateData[year] : "N/A";

          let formattedValue;
          if (value !== "N/A") {
            formattedValue = value.toLocaleString();
          } else {
            formattedValue = "N/A";
          }

          tooltip.style("display", "block")
            .html(`
              <strong>${stateName}</strong><br>
              ${metricLabels[metric]} (${year}): ${formattedValue} ${metricUnits[metric]}
            `)
            .style("left", `${event.pageX + 10}px`)
            .style("top", `${event.pageY + 10}px`);

          d3.select(event.currentTarget).attr("fill", "#db4780");
        })
        .on("mouseout", function (event, d) {
          tooltip.style("display", "none");
          const stateName = stateIdToName[d.id];
          const stateData = data[metric].find(row => row.GeoName === stateName);
          const value = stateData ? +stateData[year] : null;
          d3.select(this).attr("fill", value ? quantiles(value) : "#ccc");
        });

      updateLegend(quantiles, metric);
    };

    const updateLegend = (colorScale, metric) => {
      const legendWidth = 300, legendHeight = 10;
      const legend = d3.select("#legend").html("").append("svg")
        .attr("width", legendWidth + 150)
        .attr("height", 80);

      const quantileThresholds = colorScale.quantiles();
      quantileThresholds.forEach((threshold, i) => {
        legend.append("rect")
          .attr("x", (legendWidth / quantileThresholds.length) * i + 50)
          .attr("y", 10)
          .attr("width", legendWidth / quantileThresholds.length)
          .attr("height", legendHeight)
          .attr("fill", colorScale(threshold));
      });

      const legendScale = d3.scaleLinear()
        .domain([quantileThresholds[0], quantileThresholds[quantileThresholds.length - 1]])
        .range([50, legendWidth + 50]);

      const axis = d3.axisBottom(legendScale)
        .ticks(5)
        .tickFormat(d3.format(".2s"));

      legend.append("g")
        .attr("transform", "translate(0, 30)")
        .call(axis);

      legend.append("text")
        .attr("x", legendWidth / 1.5)
        .attr("y", 70)
        .attr("text-anchor", "middle")
        .style("fill", "black")
        .style("font-size", "14px")
        .text(`Color Scale For ${metricLabels[metric]}`);
    };

    const initializeVisualization = async () => {
      const { states, allData, years, globalMinMax } = await loadData();

      const yearSlider = d3.select("#year-slider")
        .attr("min", 0)
        .attr("max", years.length - 1)
        .attr("step", 1)
        .attr("value", 0);

      const yearLabel = d3.select("#year-label");
      const metricDropdown = d3.select("#metric");

      const updateYearLabel = (index) => {
        yearLabel.text(`Year: ${years[index]}`);
      };

      updateYearLabel(0);

      const updateVisualization = () => {
        const metric = metricDropdown.property("value");
        const yearIndex = yearSlider.property("value");
        const year = years[yearIndex];
        updateYearLabel(yearIndex);
        updateMap(states, allData, metric, year, globalMinMax);
      };

      metricDropdown.on("change", updateVisualization);
      yearSlider.on("input", updateVisualization);

      updateVisualization();
    };

    initializeVisualization();
  </script>
</body>

</html>